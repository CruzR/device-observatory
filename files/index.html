<!DOCTYPE html>

<html>
<head>
  <meta charset="utf-8" />
  <title>Device-Observatory</title>
  <style type="text/css">
    html {
      font: normal 16px verdana,arial,'Bitstream Vera Sans',helvetica,sans-serif;
      color: #000033;
    }
    td {
      text-align: center;
    }
    table {
      margin-left: auto;
      margin-right: auto;
      white-space: nowrap;
    }
  </style>
</head>
<body>
<center>
  <h1>Welcome to the Device Observatory!</h1>
</center>

<table>
  <tr>
    <th>MAC</th>
    <th>Manufacturer</th>
    <th>Host Name</th>
    <th>First Seen</th>
    <th>Last Seen</th>
  </tr>
  <tbody id="device_tbody">
  </tbody>
</table>

<br />
<br />

<table>
  <tr>
    <th>Destination</th>
    <th>Hostname</th>
    <th>Info</th>
    <th>Times Accessed</th>
    <th>First Accessed</th>
    <th>Last Accessed</th>
  </tr>
  <tbody id="activity_tbody">
  </tbody>
</table>

<script type="text/javascript">
  function $(id) {
    return document.getElementById(id);
  }

  function clearChildren(parent) {
    while (parent.firstChild) {
      parent.removeChild(parent.firstChild);
    }
  }

  function formatUnixTime(unix_timestamp) {
    var date = new Date(unix_timestamp*1000);
    // Hours part from the timestamp
    var hours = "0" + date.getHours();
    // Minutes part from the timestamp
    var minutes = "0" + date.getMinutes();
    // Seconds part from the timestamp
    var seconds = "0" + date.getSeconds();

    // Will display time in 10:30:23 format
    return hours.substr(-2) + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);
  }

  function formatDuration(time) {
    var days = Math.floor(time / 86400);
    time -= days * 86400;
    var hours = Math.floor(time / 3600);
    time -= hours * 3600;
    var minutes = Math.floor(time / 60);
    time -= hours * 60;
    var seconds = time;

    var pre = "";
    if (days > 0) {
      pre += days + " days "
    }

    return pre + ("0"+hours).substr(-2) + ':' + ("0"+minutes).substr(-2) + ':' + ("0"+seconds).substr(-2);
  }

  function formatString(s) {
    return (s && s.length) ? s : "-";
  }

  function readUrlContent(url, callback) {
    if (url.length) {
      var request = new XMLHttpRequest();
      request.onreadystatechange = function() {
        if (request.readyState == 4) {
          if (request.status == 200) {
            callback(request.responseText, url);
          } else {
            var msg = request.statusText;
            //alert('Failed to load URL: ' + url + ' (' + (msg.length ? msg : 'unknown') + ')');
          }
        }
      };
      request.open('GET', url, true);
      request.send();
    }
  }

  function append(parent, tag) {
    var e = document.createElement(tag);
    parent.appendChild(e);
    return e;
  }

  function showActivity(activity) {
    var tbody = $('activity_tbody');

    clearChildren(tbody);

    for (var addr in activity) {
      var o = activity[addr];
      var tr = append(tbody, 'tr');

      append(tr, 'td').innerText = addr;
      append(tr, 'td').innerText = formatString(o.hostname);
      append(tr, 'td').innerText = formatString(o.info);
      append(tr, 'td').innerText = "" + o.times_accessed;
      append(tr, 'td').innerText = formatDuration(o.first_accessed) + " ago";
      append(tr, 'td').innerText = formatDuration(o.last_accessed) + " ago";
    }
  }

  function processData(txt, url) {
    var tbody = $('device_tbody');

    clearChildren(tbody);

    var obj = JSON.parse(txt);
    for (var mac in obj) {
      var o = obj[mac];
      var tr = append(tbody, 'tr');
      tr.onclick = function() {
        showActivity(o.activity);
      };
      append(tr, 'td').innerText = mac;
      append(tr, 'td').innerText = formatString(o.ouiname);
      append(tr, 'td').innerText = formatString(o.hostname);
      append(tr, 'td').innerText = formatDuration(o.first_seen) + " ago";
      append(tr, 'td').innerText = formatDuration(o.last_seen) + " ago";
    }
  }

  function update() {
    readUrlContent('device-observatory.json', processData);
  }

  update();
  setInterval(update, 3000);
</script>

</body>
</html>
